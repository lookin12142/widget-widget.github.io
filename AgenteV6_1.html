<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartClic Chat Widget - 3 Estados</title>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .chat-widget {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 999999;
      transition: all 0.3s ease;
      touch-action: none;
    }

    /* Estado 1: 326x99 - Mensaje completo */
    .widget-state-1 {
      width: 326px;
      height: 99px;
      background: white;
      border-radius: 50px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      padding: 15px 20px;
      cursor: pointer;
      position: relative;
      border: 2px solid #f0f0f0;
    }

    .widget-state-1 .bot-avatar {
      width: 100px;
      height: 100px;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .widget-state-1 .bot-avatar img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .widget-state-1 .message-content {
      flex: 1;  
      font-size: 16px;  
      color: #333;
      font-weight: 500;
    }

    .widget-state-1 .close-btn {
      width: 30px;
      height: 30px;
      background: rgba(249, 43, 96, 1);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
    }

    .widget-state-1 .close-btn:hover {
      background: rgba(229, 23, 76, 1);
    }

    /* Estado 2: 106x100 - Solo bot */
    .widget-state-2 {
      width: 106px;
      height: 100px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      border: 2px solid #f0f0f0;
    }

    .widget-state-2 .bot-avatar {
      width: 100px;
      height: 100px;
    }

    .widget-state-2 .bot-avatar img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .widget-state-2 .close-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 30px;
      height: 30px;
      background: rgba(249, 43, 96, 1);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .widget-state-2 .close-btn:hover {
      background: rgba(229, 23, 76, 1);
    }

    /* Estado 3: 46x46 - Solo icono */
    .widget-state-3 {
      width: 46px;
      height: 46px; 
      background: white;
      border-radius: 50%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 2px solid #f0f0f0;
    }

    .widget-state-3 .chat-icon {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* === VENTANA DE CHAT === */
    .chat-window {
      position: fixed;
      right: 20px;
      bottom: 130px;
      width: 350px;
      height: 500px;
      background: rgba(255, 255, 255, 1);
      border-radius: 15px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      z-index: 1000000;
      overflow: hidden;
    }

    .chat-window.active {
      display: flex;
    }

    .chat-header {
      background: rgba(249, 43, 96, 1);
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-header h3 {
      font-size: 16px;
      font-weight: 600;
      text-align: center;
    }

    .chat-close {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      position: absolute;
      right: 15px;
      top: 5%;
      transform: translateY(-50%);
      transition: all 0.2s ease;
    }

    .chat-close:hover {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-50%) scale(1.1);
    }

    .chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
    }

    .message {
      display: flex;
      margin-bottom: 15px;
      align-items: flex-start;
    }

    .message.bot {
      justify-content: flex-start;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .message.bot .message-avatar {
      margin-right: 10px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .message.bot .message-avatar:hover {
      transform: scale(1.1);
    }

    .message.bot .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .message.user .message-avatar {
      background: rgba(178, 181, 218, 1);
      color: white;
      margin-left: 10px;
      order: 1;
    }

    .message-content {
      max-width: 250px;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
    }

    .message.bot .message-content {
      background: white;
      color: #333;
      border: 1px solid #e9ecef;
    }

    .message.user .message-content {
      background: rgba(244, 246, 252, 1);
      color: #333;
    }

    .chat-input-container {
      padding: 15px 20px;
      background: white;
      border-top: 1px solid #e9ecef;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 25px;
      padding: 12px 16px;
      font-size: 14px;
      outline: none;
      resize: none;
      max-height: 80px;
    }

    .chat-input:focus {
      border-color: rgba(249, 43, 96, 1);
    }

    .send-btn {
      background: rgba(249, 43, 96, 1);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .send-btn:hover {
      background: rgba(229, 23, 76, 1);
    }


    .send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

   
    .video-link-btn {
      background: rgba(249, 43, 96, 1);
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 8px 18px;
      font-size: 14px;
      font-weight: 600;
      margin: 6px 0 0 0;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(249, 43, 96, 0.15);
      transition: background 0.2s, transform 0.2s;
      display: inline-block;
    }
    .video-link-btn:hover, .video-link-btn:focus {
      background: rgba(229, 23, 76, 1);
      transform: scale(1.05);
      outline: none;
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 12px 16px;
      background: white;
      border-radius: 18px;
      border: 1px solid #e9ecef;
      max-width: 250px;
    }

    .typing-dots {
      display: flex;
      gap: 3px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background: #999;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out both;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Ocultar estados */
    .widget-state-1.hidden,
    .widget-state-2.hidden,
    .widget-state-3.hidden {
      display: none;
    }

    /* Demo controls */
    .demo-controls {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 1000001;
    }

    .demo-controls h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .demo-controls button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 10px 15px;
      background: rgba(249, 43, 96, 1);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .demo-controls button:hover {
      background: rgba(229, 23, 76, 1);
    }

    .demo-controls button.active {
      background: #2ed573;
    }

    /* === RESPONSIVE DESIGN PARA MÓVIL === */
    @media screen and (max-width: 768px) {
      body {
        padding: 10px;
      }

      /* Widget más pequeño en móvil */
      .chat-widget {
        right: 15px;
        bottom: 15px;
      }

      /* Estado 1 más pequeño */
      .widget-state-1 {
        width: 280px;
        height: 85px;
        padding: 12px 15px;
        border-radius: 40px;
      }

      .widget-state-1 .bot-avatar {
        width: 50px;
        height: 50px;
        margin-right: 12px;
      }

      .widget-state-1 .message-content {
        font-size: 14px;
      }

      .widget-state-1 .close-btn {
        width: 25px;
        height: 25px;
        font-size: 16px;
        margin-left: 8px;
      }

      /* Estado 2 más pequeño */
      .widget-state-2 {
        width: 90px;
        height: 85px;
      }

      .widget-state-2 .bot-avatar {
        width: 60px;
        height: 60px;
      }

      .widget-state-2 .close-btn {
        width: 25px;
        height: 25px;
        font-size: 14px;
        top: -8px;
        right: -8px;
      }

      /* Estado 3 más pequeño */
      .widget-state-3 {
        width: 55px;
        height: 55px;
      }

      /* Chat window responsive */
      .chat-window {
        right: 15px;
        bottom: 110px;
        width: calc(100vw - 30px);
        max-width: 350px;
        height: 450px;
      }

      .chat-header {
        padding: 12px 15px;
      }

      .chat-header h3 {
        font-size: 15px;
      }

      .chat-close {
        width: 30px;
        height: 30px;
        font-size: 18px;
        right: 12px;
      }

      .chat-body {
        padding: 15px;
      }

      .message-content {
        max-width: 220px;
        padding: 10px 14px;
        font-size: 13px;
      }

      .message-avatar {
        width: 30px;
        height: 30px;
        font-size: 14px;
      }

      .chat-input-container {
        padding: 12px 15px;
      }

      .chat-input {
        padding: 10px 14px;
        font-size: 13px;
      }

      .send-btn {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }

      /* Controles de demo más pequeños */
      .demo-controls {
        top: 15px;
        left: 15px;
        padding: 15px;
        max-width: calc(100vw - 30px);
      }

      .demo-controls h3 {
        font-size: 14px;
        margin-bottom: 12px;
      }

      .demo-controls button {
        padding: 8px 12px;
        font-size: 13px;
        margin-bottom: 8px;
      }
    }

    /* Para pantallas muy pequeñas (móviles pequeños) */
    @media screen and (max-width: 480px) {
      /* Estado 1 aún más pequeño */
      .widget-state-1 {
        width: 250px;
        height: 75px;
        padding: 10px 12px;
      }

      .widget-state-1 .bot-avatar {
        width: 45px;
        height: 45px;
        margin-right: 10px;
      }

      .widget-state-1 .message-content {
        font-size: 13px;
      }

      /* Chat window en pantalla completa en móviles pequeños */
      .chat-window {
        right: 10px;
        bottom: 90px;
        width: calc(100vw - 20px);
        height: calc(100vh - 120px);
        max-height: 500px;
      }

      .message-content {
        max-width: 180px;
        padding: 8px 12px;
        font-size: 12px;
      }

      .message-avatar {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }

      /* Ocultar controles de demo en móviles muy pequeños */
      .demo-controls {
        display: none;
      }
    }

    /* Para landscape en móviles */
    @media screen and (max-width: 768px) and (orientation: landscape) {
      .chat-window {
height: calc(100vh - 90px);
        max-height: 400px;
      }
    }
  </style>
</head>
<body>



<!-- Widget de Chat -->
<div class="chat-widget">
  <!-- Estado 1: 326x99 -->
  <div class="widget-state-1" id="widget-state-1">
    <div class="bot-avatar">
    <!--  <img src="https://agentesia.s3.us-west-2.amazonaws.com/bot-icon.png" alt="Bot Assistant" /> -->
    <img src="./assets/Icons-chatbot.svg" alt="Bot Assistant" />
    </div>
    <div class="message-content">¡Hola! ¿Te puedo ayudar?</div>
    <button class="close-btn" onclick="nextState(1)">×</button>
  </div>

  <!-- Estado 2: 106x100 -->
  <div class="widget-state-2 hidden" id="widget-state-2">
    <div class="bot-avatar">
   <!--  <img src="https://agentesia.s3.us-west-2.amazonaws.com/bot-icon.png" alt="Bot Assistant" /> -->
     <img src="./assets/Icons-chatbot.svg" alt="Bot Assistant" />
    </div>
    <button class="close-btn" onclick="nextState(2)">×</button>
  </div>

  <!-- Estado 3: 46x46 -->
  <div class="widget-state-3 hidden" id="widget-state-3" style="touch-action: none;">
     <!--   <img class="chat-icon" src="https://agentesia.s3.us-west-2.amazonaws.com/chat-icon.png" alt="Chat Icon" /> -->
  <img src="./assets/Frame_705.svg" alt="Bot Assistant" />
    </div>
</div>

<!-- Ventana de Chat -->
<div class="chat-window" id="chat-window">
  <div class="chat-header">
    <h3>Asistente Virtual</h3>
    <button class="chat-close" onclick="closeChat()">×</button>
  </div>
  
  <div class="chat-body" id="chat-body">
    <div class="message bot">
      <div class="message-avatar">
        <!--  <img src="https://agentesia.s3.us-west-2.amazonaws.com/bot-icon.png" alt="Bot Assistant" /> -->
           <img src="./assets/Icons-chatbot.svg" alt="Bot Assistant" />
      </div>
      <div class="message-content">¡Hola soy Smarty tu asistente virtual ¿En qué puedo ayudarte?</div>
    </div>
  </div>
  
  <div class="chat-input-container">
    <textarea class="chat-input" id="chat-input" placeholder="Escribe un mensaje" rows="1"></textarea>
    <button class="send-btn" id="send-btn" onclick="sendMessage()">➤</button>
  </div>
</div>

<script>
// Estado actual del widget
let currentState = 1;
let isTyping = false;

// Configuración del webhook
const config = {
  webhookUrl: 'https://n8n.smartclic.pe/webhook/7590bb30-5b2b-4a50-8733-9c62246b7888/chat',
  userId: 'USR-41244',
  tenantId: 'TENANT-ACME',
  chanel: 'web',
  ruc: '2012344125639',
  razon_social: 'HIDALGO IMPRESORES EMPRESA INDIVIDUAL DE RESPONSABILIDAD LIMITADA',
  sessionId: 'TENANT-ACME:USR-512512'
};

// Elementos del DOM
const estado1 = document.getElementById('widget-state-1');
const estado2 = document.getElementById('widget-state-2');
const estado3 = document.getElementById('widget-state-3');

const chatWindow = document.getElementById('chat-window');
const chatBody = document.getElementById('chat-body');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');


// Eliminar controles de demo y funciones de cambio de estado
function showState(stateNumber) {
  // Ocultar todos los estados
  estado1.classList.add('hidden');
  estado2.classList.add('hidden');
  estado3.classList.add('hidden');
  // Mostrar el estado seleccionado
  currentState = stateNumber;
  switch(stateNumber) {
    case 1:
      estado1.classList.remove('hidden');
      chatWindow.style.bottom = '130px';
      break;
    case 2:
      estado2.classList.remove('hidden');
      chatWindow.style.bottom = '130px';
      break;
    case 3:
      estado3.classList.remove('hidden');
      chatWindow.style.bottom = '60px';
      break;
  }
}

function nextState(fromState) {
  if (fromState === 1) {
    showState(2);
  } else if (fromState === 2) {
    showState(3);
  }
}


// Solo permitir abrir/cerrar chat desde el widget
estado1.addEventListener('click', (e) => {
  if (!e.target.classList.contains('close-btn')) {
    toggleChat();
  }
});
estado2.addEventListener('click', (e) => {
  if (!e.target.classList.contains('close-btn')) {
    toggleChat();
  }
});

// Drag & drop para el ícono del chat (widget-state-3)
let dragOffsetX = 0;
let dragOffsetY = 0;
let isDragging = false;

const widget1 = document.getElementById('widget-state-1');
const widget2 = document.getElementById('widget-state-2');
const widget3 = document.getElementById('widget-state-3');
const chatWidget = document.querySelector('.chat-widget');
const chatWindowEl = document.getElementById('chat-window');

function setWidgetPosition(x, y) {
  chatWidget.style.left = x + 'px';
  chatWidget.style.top = y + 'px';
  chatWidget.style.right = '';
  chatWidget.style.bottom = '';
}

function getWidgetPosition() {
  const rect = chatWidget.getBoundingClientRect();
  return { x: rect.left, y: rect.top };
}

function onDragStart(e) {
  isDragging = true;
  let clientX, clientY;
  if (e.type.startsWith('touch')) { 
    clientX = e.touches[0].clientX;
    clientY = e.touches[0].clientY;
  } else {
    clientX = e.clientX;
    clientY = e.clientY;
  }
  const rect = chatWidget.getBoundingClientRect();
  dragOffsetX = clientX - rect.left;
  dragOffsetY = clientY - rect.top;
  document.addEventListener('mousemove', onDragMove); 
  document.addEventListener('mouseup', onDragEnd);
  document.addEventListener('touchmove', onDragMove, { passive: false });
  document.addEventListener('touchend', onDragEnd);
}

function onDragMove(e) {
  if (!isDragging) return;
  let clientX, clientY;
  if (e.type.startsWith('touch')) { 
    clientX = e.touches[0].clientX;
    clientY = e.touches[0].clientY;
    e.preventDefault();
  } else {
    clientX = e.clientX;
    clientY = e.clientY;
  }
  const rect = chatWidget.getBoundingClientRect();
  let x = clientX - dragOffsetX;
  let y = clientY - dragOffsetY;
  // Permitir mover libremente, pero mostrar el widget mientras se arrastra
  setWidgetPosition(x, y);
}

function onDragEnd() {
  isDragging = false;
  document.removeEventListener('mousemove', onDragMove);
  document.removeEventListener('mouseup', onDragEnd);
  document.removeEventListener('touchmove', onDragMove);
  document.removeEventListener('touchend', onDragEnd);
  // Snap automático al borde más cercano o volver a su último borde si está en el centro
  const rect = chatWidget.getBoundingClientRect();
  const w = chatWidget.offsetWidth;
  const h = chatWidget.offsetHeight;
  const winW = window.innerWidth;
  const winH = window.innerHeight;
  // Distancias a cada borde
  const distLeft = rect.left;
  const distRight = winW - (rect.left + w);
  const distTop = rect.top;
  const distBottom = winH - (rect.top + h);
  const minDist = Math.min(distLeft, distRight, distTop, distBottom);
  let snap;
  if (minDist === distLeft) snap = 'left';
  else if (minDist === distRight) snap = 'right';
  else if (minDist === distTop) snap = 'top';
  else snap = 'bottom';

  const centerX = rect.left + w/2;
  const centerY = rect.top + h/2;
  const isCenter = (
    centerX > winW*0.25 && centerX < winW*0.75 &&
    centerY > winH*0.25 && centerY < winH*0.75
  );
  const margin = 6; // margen de seguridad para todos los bordes
  if (isCenter) {
    // Volver a la última posición anclada, siempre visible
    if (window.lastSnap === 'left') {
      chatWidget.style.left = margin + 'px'; chatWidget.style.right = '';
      chatWidget.style.top = Math.max(margin, Math.min(rect.top, winH - h - margin)) + 'px';
      chatWidget.style.bottom = '';
    } else if (window.lastSnap === 'right') {
      chatWidget.style.left = '';
      chatWidget.style.right = margin + 'px';
      chatWidget.style.top = Math.max(margin, Math.min(rect.top, winH - h - margin)) + 'px';
      chatWidget.style.bottom = '';
    } else if (window.lastSnap === 'top') {
      chatWidget.style.top = margin + 'px'; chatWidget.style.bottom = '';
      chatWidget.style.left = Math.max(margin, Math.min(rect.left, winW - w - margin)) + 'px';
      chatWidget.style.right = '';
    } else if (window.lastSnap === 'bottom') {
      chatWidget.style.top = '';
      chatWidget.style.bottom = margin + 'px';
      chatWidget.style.left = Math.max(margin, Math.min(rect.left, winW - w - margin)) + 'px';
      chatWidget.style.right = '';
    } else {
      chatWidget.style.right = margin + 'px'; chatWidget.style.bottom = margin + 'px';
    }
  } else {
    // Snap al borde más cercano, siempre visible
    if (snap === 'left') {
      chatWidget.style.left = margin + 'px';
      chatWidget.style.right = '';
      let top = Math.max(margin, Math.min(rect.top, winH - h - margin));
      chatWidget.style.top = top + 'px';
      chatWidget.style.bottom = '';
      window.lastSnap = 'left';
    } else if (snap === 'right') {
      chatWidget.style.left = '';
      chatWidget.style.right = margin + 'px';
      let top = Math.max(margin, Math.min(rect.top, winH - h - margin));
      chatWidget.style.top = top + 'px';
      chatWidget.style.bottom = '';
      window.lastSnap = 'right';
    } else if (snap === 'top') {
      chatWidget.style.top = margin + 'px';
      chatWidget.style.bottom = '';
      let left = Math.max(margin, Math.min(rect.left, winW - w - margin));
      chatWidget.style.left = left + 'px';
      chatWidget.style.right = '';
      window.lastSnap = 'top';
    } else if (snap === 'bottom') {
      chatWidget.style.top = '';
      chatWidget.style.bottom = margin + 'px';
      let left = Math.max(margin, Math.min(rect.left, winW - w - margin));
      chatWidget.style.left = left + 'px';
      chatWidget.style.right = '';
      window.lastSnap = 'bottom';
    }
  }
}

// Habilitar drag en los tres estados

// Solo permitir drag en dispositivos móviles (touch)
function isMobileDevice() {
 return (typeof window.orientation !== "undefined") || 
 (navigator.userAgent.indexOf('IEMobile') !== -1) || 
  ('ontouchstart' in window);}


 /* nction isMobileDevice() {
    // Método 1: Por ancho de pantalla (más confiable para responsividad)
    if (window.innerWidth <= 768) return true;
    
    // Método 2: Detección moderna de touch primario
    if (window.matchMedia("(pointer: coarse)").matches) return true;
    
    // Método 3: User agent como fallback
    const userAgent = navigator.userAgent.toLowerCase();
    return /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
}*/

if (isMobileDevice()) {
  [widget1, widget2, widget3].forEach(widget => {
    widget.addEventListener('touchstart', onDragStart);
  });
}

// Abrir chat en la posición del ícono 
widget3.addEventListener('click', function(e) {
  if (!isDragging) {
    // Restaurar posición y tamaño por defecto del chat solo al abrir
    if (!chatWindowEl.classList.contains('active')) {
      chatWindowEl.style.left = '';
      chatWindowEl.style.top = '';
      chatWindowEl.style.right = '';
      chatWindowEl.style.bottom = '';
      chatWindowEl.style.width = '';
      chatWindowEl.style.maxWidth = '';
      chatWindowEl.style.height = '';
      chatWindowEl.style.maxHeight = '';
      chatWindowEl.style.transform = '';
      chatWindowEl.style.position = '';
      openChat();
    } else {
      closeChat();
    }
  }
});

// Suavidad para el movimiento del widget
chatWidget.style.transition = 'left 0.15s cubic-bezier(0.4,0,0.2,1), top 0.15s cubic-bezier(0.4,0,0.2,1)';

// Funciones del chat
function toggleChat() {
  if (chatWindow.classList.contains('active')) {
    closeChat();
  } else {
    openChat();
  }
}

function openChat() {
  chatWindow.classList.add('active');
  // Ajustar posición según el estado actual
  if (currentState === 3) {
    chatWindow.style.bottom = '60px';
  } else {
    chatWindow.style.bottom = '130px';
  }
  chatInput.focus();
}

function closeChat() {
  chatWindow.classList.remove('active');
}

function addMessage(content, isBot = false) {
  const message = document.createElement('div');
  message.className = `message ${isBot ? 'bot' : 'user'}`;
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  if (isBot) {
    const img = document.createElement('img');
    /* img.src = 'https://agentesia.s3.us-west-2.amazonaws.com/bot-icon.png'; */
    img.src = './assets/Icons-chatbot.svg';
    img.alt = 'Bot Assistant';
    avatar.appendChild(img);
    
    // Agregar funcionalidad para cerrar el chat al hacer clic en el avatar del bot
    avatar.style.cursor = 'pointer';
    avatar.addEventListener('click', closeChat);
  } else {
  avatar.innerHTML = '<img src="./assets/Icons-user.svg" style="width:100%;height:100%;">';
  }
  
  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  
  if (isBot) {
    // Procesar markdown básico para el bot
    messageContent.innerHTML = processMarkdown(content);
  } else {
    messageContent.textContent = content;
  }
  
  message.appendChild(avatar);
  message.appendChild(messageContent);
  
  chatBody.appendChild(message);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function addTypingIndicator() {
  const message = document.createElement('div');
  message.className = 'message bot';
  message.id = 'typing-indicator';
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  const img = document.createElement('img');
  /* img.src = 'https://agentesia.s3.us-west-2.amazonaws.com/bot-icon.png'; */
  img.src = './assets/Icons-chatbot.svg';

  img.alt = 'Bot Assistant';
  avatar.appendChild(img);
  
  avatar.style.cursor = 'pointer';
  avatar.addEventListener('click', closeChat);
  
  const typingDiv = document.createElement('div');
  typingDiv.className = 'typing-indicator';
  
  const dotsContainer = document.createElement('div');
  dotsContainer.className = 'typing-dots';
  
  for (let i = 0; i < 3; i++) {
    const dot = document.createElement('div');
    dot.className = 'typing-dot';
    dotsContainer.appendChild(dot);
  }
  
  typingDiv.appendChild(dotsContainer);
  message.appendChild(avatar);
  message.appendChild(typingDiv);
  
  chatBody.appendChild(message);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function removeTypingIndicator() {
  const indicator = document.getElementById('typing-indicator');
  if (indicator) {
    indicator.remove();
  }
}

function processMarkdown(text) {

  if (!text) return '';
 
  text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

 
  text = text.replace(/Ver video aquí \[(https?:\/\/[^\]]+)\]/g, function(match, url) {
    return `<button class="video-link-btn" onclick=\"window.open('${url}', '_blank')\">Ver video aquí</button>`;
  });
 
  text = text.replace(/Ver video aquí (https?:\/\/[\w\-\.\?&=\/%#]+)(?![\]\w])/g, function(match, url) {
    return `<button class="video-link-btn" onclick=\"window.open('${url}', '_blank')\">Ver video aquí</button>`;
  });

  text = text
    .replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*([^*]+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+?)`/g, '<code>$1</code>')
    .replace(/\n/g, '<br>');
  return text;
}

async function sendMessage() {
  const message = chatInput.value.trim();
  if (!message || isTyping) return;
  
  // Agregar mensaje del usuario
  addMessage(message, false);
  chatInput.value = '';
  
  // Mostrar indicador de escritura
  isTyping = true;
  sendBtn.disabled = true;
  addTypingIndicator();
  
  try {
    const payload = {
      sessionId: config.sessionId,
      chatInput: message,
      userId: config.userId,
      tenantId: config.tenantId,
      ruc: config.ruc,
      razon_social: config.razon_social,
      messageId: 'msg-' + Date.now()
    };
    
    const response = await fetch(config.webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    
    const result = await response.text();
    let botMessage = 'Lo siento, no pude procesar tu mensaje.';
    
    try {
      const jsonResult = JSON.parse(result);
      botMessage = jsonResult.result || jsonResult.text || jsonResult.output || jsonResult.response || result;
    } catch {
      botMessage = result || 'Mensaje recibido correctamente.';
    }
    
    // Simular delay de respuesta
    setTimeout(() => {
      removeTypingIndicator();
      addMessage(botMessage, true);
      isTyping = false;
      sendBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Error al enviar mensaje:', error);
    setTimeout(() => {
      removeTypingIndicator();
      addMessage('Lo siento, hubo un error de conexión. Intenta de nuevo.', true);
      isTyping = false;
      sendBtn.disabled = false;
    }, 1000);
  }
}

// Event listeners para el chat
chatInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Auto-resize del textarea
chatInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 80) + 'px';
});

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
  showState(1);
  // Si el estado guardado es 3, ajustar posición del chat
  if (currentState === 3) {
    chatWindow.style.bottom = '60px';
  } else {
    chatWindow.style.bottom = '130px';
  }
  // Agregar funcionalidad de cerrar chat al avatar del mensaje inicial del bot
  const initialBotAvatar = document.querySelector('.chat-body .message.bot .message-avatar');
  if (initialBotAvatar) {
    initialBotAvatar.addEventListener('click', closeChat);
  }
});
</script>

</body>

</html>

