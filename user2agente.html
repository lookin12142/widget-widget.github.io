<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartClic Chat Widget</title>
  <style>
    :root {
      --sc-primary: #4f46e5; /* indigo-600 */
      --sc-bg: #0b1020;      /* dark panel */
      --sc-bg-soft: #12172a; /* soft panel */
      --sc-text: #e7e7ee;    /* light text */
      --sc-muted: #a8a8b8;   /* muted text */
      --sc-danger: #ef4444;
      --sc-shadow: 0 10px 30px rgba(2, 6, 23, .35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    /* Floating FAB */
    .sc-fab { position: fixed; right: 18px; bottom: 18px; z-index: 999999; }
    .sc-fab button {
      border: 0; border-radius: 999px; padding: 14px 16px; cursor: pointer;
      background: var(--sc-primary); color: white; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;
      box-shadow: var(--sc-shadow); transition: transform .1s ease, box-shadow .2s ease; will-change: transform; 
    }
    .sc-fab button:hover { transform: translateY(-1px); box-shadow: 0 16px 38px rgba(2,6,23,.45); }
    .sc-fab .sc-dot { width: 10px; height: 10px; background: white; border-radius: 999px; opacity: .9; }
    /* Panel */
    .sc-panel { position: fixed; right: 18px; bottom: 84px; width: min(380px, calc(100vw - 24px)); height: 560px;
      background: linear-gradient(180deg, var(--sc-bg) 0%, var(--sc-bg-soft) 100%);
      color: var(--sc-text); border-radius: var(--radius); overflow: hidden; box-shadow: var(--sc-shadow); display: none; z-index: 999999; }
    .sc-panel.sc-open { display: grid; grid-template-rows: auto 1fr auto; }
    .sc-header { padding: 14px 16px; background: rgba(255,255,255,.04); display: flex; align-items: center; justify-content: space-between; gap: 8px; border-bottom: 1px solid rgba(255,255,255,.06); }
    .sc-title { font-weight: 700; font-size: 15px; letter-spacing: .2px; }
    .sc-sub { font-size: 12px; color: var(--sc-muted); }
    .sc-actions { display: flex; align-items: center; gap: 6px; }
    .sc-iconbtn { background: transparent; color: var(--sc-text); border: 0; padding: 8px; border-radius: 10px; cursor: pointer; }
    .sc-iconbtn:hover { background: rgba(255,255,255,.06); }
    .sc-msgs { padding: 14px; overflow-y: auto; scroll-behavior: smooth; }
    .sc-msg { margin: 8px 0; display: flex; gap: 8px; }
    .sc-msg-inner { max-width: 85%; padding: 10px 12px; border-radius: 14px; white-space: pre-wrap; word-wrap: break-word; line-height: 1.35; }
    .from-user .sc-msg-inner { margin-left: auto; background: #1f2a44; color: #ebf1ff; border-top-right-radius: 4px; }
    .from-assistant .sc-msg-inner { background: rgba(255,255,255,.06); border-top-left-radius: 4px; }
    .from-system .sc-msg-inner { background: rgba(99,102,241,.18); border: 1px solid rgba(99,102,241,.35); color: #dfe2ff; font-size: 12px; }

    /* Composer */
    .sc-compose { padding: 10px; border-top: 1px solid rgba(255,255,255,.06); background: rgba(255,255,255,.02); display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    .sc-textarea { resize: none; height: 56px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.03); color: var(--sc-text); padding: 10px 12px; outline: none; }
    .sc-send {
      background: var(--sc-primary); color: white; border: 0; border-radius: 12px; padding: 0 16px; font-weight: 700; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; }
    .sc-send[disabled] { opacity: .6; cursor: not-allowed; }

    .sc-typing { display: inline-flex; gap: 4px; align-items: center; }
    .sc-typing .d { width: 6px; height: 6px; background: #cbd5ff; border-radius: 999px; animation: blink 1s infinite ease-in-out; }
    .sc-typing .d:nth-child(2){ animation-delay: .15s }
    .sc-typing .d:nth-child(3){ animation-delay: .3s }
    @keyframes blink { 0%, 80%, 100% { opacity: .25; transform: translateY(0) } 40% { opacity: 1; transform: translateY(-2px) } }

    .sc-badge { font-size: 11px; color: var(--sc-muted); }
    .sc-error { color: var(--sc-danger); font-size: 12px; }
    .sc-copy { background: transparent; color: var(--sc-muted); border: 0; font-size: 11px; cursor: pointer; padding: 2px 6px; border-radius: 8px; }
    .sc-copy:hover{ color: #fff; background: rgba(255,255,255,.06); }
  </style>
</head>
<body>
<div id="smartclic-chat-root"></div>

<script>
(function(){
  // Helper: safe uuid
  const uuid = () => {
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return 'm-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,10);
  };


  const storage = {
    key: (sid)=>`smartclic:chat:${sid}`,
    read(sid){ try { return JSON.parse(localStorage.getItem(this.key(sid))||'[]')} catch{ return [] } },
    write(sid, arr){ try { localStorage.setItem(this.key(sid), JSON.stringify(arr.slice(-500))) } catch{} },
    clear(sid){ try { localStorage.removeItem(this.key(sid)) } catch{} }
  };
  

  function createEl(tag, attrs={}, children=[]) {
    const el = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k === 'class') el.className = v; else if (k === 'text') el.textContent = v; else if (k.startsWith('on') && typeof v === 'function') el[k] = v; else el.setAttribute(k,v);
    }
    for (const c of (Array.isArray(children) ? children : [children])) if (c) el.appendChild(c);
    return el;
  }

  function processMarkdown(text) {
  if (!text) return '';
  text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  const linkStore = [];
  let linkIndex = 0;
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, linkText, url) {
    const placeholder = `__LINK_${linkIndex}__`;
    linkStore[linkIndex] = `<a href="${url}" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
    linkIndex++;
    return placeholder;
  });
  text = text
    .replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>')  
    .replace(/(?<!\*)\*([^*\s][^*]*?[^*\s])\*(?!\*)/g, '<em>$1</em>'); 
  linkStore.forEach((link, index) => {
    text = text.replace(`__LINK_${index}__`, link);
  });
  text = text.replace(/(?<!href=["'])(?<!>)(https?:\/\/[^\s<>"{}|\\^`[\]]+)(?!<\/a>)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
  text = text.replace(/(\d+\.\s)/g, '<strong>$1</strong>');
  text = text.replace(/\n/g, '<br>');
  
  return text;
}

  function renderMsg({sender, text}){
    const row = createEl('div', {class: `sc-msg from-${sender||'system'}`});
    const bubble = createEl('div', {class:'sc-msg-inner'});
   
  if (sender === 'assistant') {
  bubble.innerHTML = processMarkdown(text || '');
  } else {
  bubble.innerHTML = (text || '').replace(/\n/g, '<br>');
  }


    if (sender === 'assistant') {
      const tools = createEl('div');
      const btn = createEl('button', {class:'sc-copy', text:'Copiar'});
      btn.addEventListener('click', ()=> navigator.clipboard.writeText(text||''));
      tools.appendChild(btn);
      bubble.appendChild(createEl('div', {style:'height:6px'}));
      bubble.appendChild(tools);
    }
    row.appendChild(bubble);
    return row;
  }

  function typingDots(){
    const w = createEl('div', {class:'sc-msg from-assistant'});
    const b = createEl('div', {class:'sc-msg-inner'});
    const t = createEl('div', {class:'sc-typing'});
    t.appendChild(createEl('div', {class:'d'}));
    t.appendChild(createEl('div', {class:'d'}));
    t.appendChild(createEl('div', {class:'d'}));
    b.appendChild(t); w.appendChild(b); return w;
  }

  function SmartclicWidget(opts){
    const cfg = Object.assign({
      webhookUrl: 'https://n8n.smartclic.pe/webhook/dac6fef4-be0b-4d46-b717-9fb92cbd1450/chat',
      title: 'SmartClic Assistant', sub: 'Conectado a tu RAG',
      sessionId: null, userId: null, tenantId: null, ruc: null, razon_social: null,
      extraHeaders: {},
    }, opts||{});

    if (!cfg.sessionId) {
      const sidBase = (cfg.tenantId? cfg.tenantId + ':' : '') + (cfg.userId || 'anon');
      cfg.sessionId = sidBase; // estable por usuario
    }

    const root = document.getElementById('smartclic-chat-root');
    // FAB
    const fab = createEl('div', {class:'sc-fab'}, [
      createEl('button', {id:'sc-fab-btn'}, [
        createEl('span',{class:'sc-dot'}),
        createEl('span',{text:'Abrir chat'})
      ])
    ]);

    // Panel
    const panel = createEl('div', {class:'sc-panel', id:'sc-panel'});
    const header = createEl('div', {class:'sc-header'}, [
      createEl('div', {}, [ createEl('div',{class:'sc-title', text: cfg.title}), createEl('div',{class:'sc-sub', text: cfg.sub}) ]),
      createEl('div', {class:'sc-actions'}, [
        createEl('button',{class:'sc-iconbtn', title:'Limpiar', id:'sc-clear'}, [createEl('span',{text:'üßπ'})]),
        createEl('button',{class:'sc-iconbtn', title:'Cerrar', id:'sc-close'}, [createEl('span',{text:'‚úï'})]),
      ])
    ]);
    const msgs = createEl('div', {class:'sc-msgs', id:'sc-msgs'});
    const compose = createEl('div', {class:'sc-compose'}, []);
    const ta = createEl('textarea', {class:'sc-textarea', id:'sc-input', placeholder:'Escribe tu mensaje... (Enter para enviar, Shift+Enter salto de l√≠nea)'});
    const send = createEl('button', {class:'sc-send', id:'sc-send'}, [createEl('span',{text:'Enviar'})]);
    compose.appendChild(ta); compose.appendChild(send);

    panel.appendChild(header); panel.appendChild(msgs); panel.appendChild(compose);
    root.appendChild(fab); root.appendChild(panel);

    // Load history
    let history = storage.read(cfg.sessionId);
    if (history.length === 0) {
      history.push({sender:'system', text:'Hola üëã ¬øen qu√© te ayudo hoy?'});
      storage.write(cfg.sessionId, history);
    }
    history.forEach(m => msgs.appendChild(renderMsg(m)));
    msgs.scrollTop = msgs.scrollHeight;

    // UI events
    const open = ()=> panel.classList.add('sc-open');
    const close= ()=> panel.classList.remove('sc-open');
    document.getElementById('sc-fab-btn').onclick = ()=>{ panel.classList.toggle('sc-open'); if (panel.classList.contains('sc-open')) ta.focus(); };
    document.getElementById('sc-close').onclick = close;
    document.getElementById('sc-clear').onclick = ()=>{ storage.clear(cfg.sessionId); msgs.innerHTML=''; history=[]; };

    ta.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send.click(); }
    });

    async function sendMessage(){
      const text = ta.value.trim();
      if (!text) return;
      ta.value = '';
      const userMsg = { sender:'user', text };
      history.push(userMsg); msgs.appendChild(renderMsg(userMsg)); msgs.scrollTop = msgs.scrollHeight; storage.write(cfg.sessionId, history);

      const typing = typingDots(); msgs.appendChild(typing); msgs.scrollTop = msgs.scrollHeight;

      const messageId = uuid();
      const payload = {
        sessionId: cfg.sessionId,
        chatInput: text,
        userId: cfg.userId,
        tenantId: cfg.tenantId,
        ruc: cfg.ruc,
        razon_social: cfg.razon_social,
        messageId
      };

      let backoff = 600; let attempts = 0; let ok = false; let responseText = '';
      while (attempts < 3 && !ok) {
        attempts++;
        try {
          const res = await fetch(cfg.webhookUrl, {
            method: 'POST',
            headers: Object.assign({ 'content-type': 'application/json' }, cfg.extraHeaders || {}),
            body: JSON.stringify(payload)
          });
          const raw = await res.text();
          // intenta parsear JSON y extraer campos comunes
          try {
            const j = JSON.parse(raw);
            responseText = (j.result || j.text || j.output || j.response || raw || '').toString();
          } catch { responseText = raw || 'Mensaje enviado.'; }
          ok = res.ok;
          if (!ok) throw new Error('HTTP '+res.status);
        } catch (err) {
          if (attempts >= 3) {
            responseText = 'No pude conectar con el servidor. Intenta de nuevo en unos segundos.';
            break;
          }
          await new Promise(r => setTimeout(r, backoff));
          backoff *= 2;
        }
      }

      typing.remove();
      const assistantMsg = { sender:'assistant', text: responseText };
      history.push(assistantMsg); msgs.appendChild(renderMsg(assistantMsg)); msgs.scrollTop = msgs.scrollHeight; storage.write(cfg.sessionId, history);
    }

    send.onclick = sendMessage;
  }

  // API global
  window.SmartclicChat = {
    init(opts){ return new SmartclicWidget(opts); }
  };

  // Auto-init (optional demo). Replace with your own init call.
  window.addEventListener('DOMContentLoaded', () => {
    // Lee posibles datos embebidos en el DOM (data-attrs) si quisieras
    // Aqu√≠ dejamos un init vac√≠o para que el integrador lo configure.
  });
})();
</script>

 
<script>
  SmartclicChat.init({
    webhookUrl: 'https://n8n.smartclic.pe/webhook/dac6fef4-be0b-4d46-b717-9fb92cbd1450/chat',
    userId: 'lucas',
    tenantId: 'ATENfANT-ACME',
    ruc: '2012344125639',
    razon_social: 'ACME S.A.C.',
    sessionId: 'TENANT-ACME:USR-5131225125' // si no lo pones, se arma como tenant:user
  });
</script>

</body>
</html>
